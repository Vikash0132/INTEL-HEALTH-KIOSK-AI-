#!/usr/bin/env python3
"""
Intel AI Healthcare Kiosk Demo Script
=====================================

This script demonstrates the key features of the Intel AI Healthcare Kiosk:
1. Vitals collection and analysis
2. AI health assessment
3. Multilingual support
4. First aid guidance

Run this script to see the system in action without the UI.
"""

import asyncio
import json
import sys
import os
from datetime import datetime

# Add src to path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'src'))

from src.ai_agent import HealthcareAIAgent
from src.vitals_system import VitalsCollectionSystem
from src.multilingual_support import MultilingualSupport
from config.config import Config

class HealthcareKioskDemo:
    """Demo class to showcase healthcare kiosk functionality"""
    
    def __init__(self):
        """Initialize demo components"""
        print("üè• Initializing Intel AI Healthcare Kiosk Demo...")
        
        try:
            self.ai_agent = HealthcareAIAgent()
            self.vitals_system = VitalsCollectionSystem()
            self.multilingual = MultilingualSupport()
            print("‚úÖ All components initialized successfully!")
        except Exception as e:
            print(f"‚ùå Initialization failed: {str(e)}")
            print("üîß Please ensure your .env file has a valid GOOGLE_API_KEY")
            sys.exit(1)
    
    def load_sample_data(self):
        """Load sample vital signs data"""
        try:
            with open('data/sample_data.json', 'r') as f:
                return json.load(f)
        except FileNotFoundError:
            print("‚ö†Ô∏è Sample data file not found, using default values")
            return {
                "sample_vitals": {
                    "normal_patient": {
                        "heart_rate": 72,
                        "blood_pressure_systolic": 110,
                        "blood_pressure_diastolic": 70,
                        "body_temperature": 36.8,
                        "height": 170,
                        "weight": 65
                    }
                }
            }
    
    def demonstrate_vitals_collection(self, patient_data):
        """Demonstrate vitals collection system"""
        print("\nüìä === VITALS COLLECTION DEMO ===")
        print(f"Collecting vitals for sample patient...")
        
        # Collect vitals
        collected_vitals = self.vitals_system.collect_multiple_vitals(patient_data)
        
        print(f"‚úÖ Collected {len(collected_vitals)} vital signs:")
        for vital_name, vital_sign in collected_vitals.items():
            status_emoji = {
                'normal': '‚úÖ',
                'high': 'üî¥',
                'low': 'üîµ',
                'critical': 'üö®'
            }
            emoji = status_emoji.get(vital_sign.status, '‚ùì')
            print(f"  {emoji} {vital_sign.name}: {vital_sign.value} {vital_sign.unit} ({vital_sign.status})")
        
        # Calculate derived vitals
        derived = self.vitals_system.calculate_derived_vitals()
        if derived:
            print(f"\nüìà Calculated {len(derived)} derived vital(s):")
            for vital_name, vital_sign in derived.items():
                print(f"  üìä {vital_sign.name}: {vital_sign.value:.1f} {vital_sign.unit}")
        
        # Get health score
        health_score = self.vitals_system.get_health_score()
        print(f"\nüéØ Health Score: {health_score['score']}/100 - {health_score['grade']}")
        
        # Get summary
        summary = self.vitals_system.get_vitals_summary()
        if summary['critical_vitals']:
            print("üö® CRITICAL VITALS DETECTED!")
            for vital in summary['critical_vitals']:
                print(f"  ‚ö†Ô∏è {vital['name']}: {vital['value']} {vital['unit']}")
        
        return {name: vs.value for name, vs in collected_vitals.items()}
    
    async def demonstrate_ai_assessment(self, vitals_data, language='en'):
        """Demonstrate AI health assessment"""
        print(f"\nü§ñ === AI HEALTH ASSESSMENT DEMO ({language.upper()}) ===")
        
        # Sample health queries
        sample_queries = {
            'en': [
                "What do my vital signs indicate about my health?",
                "Should I be concerned about my blood pressure?",
                "What are the next steps I should take?"
            ],
            'hi': [
                "‡§Æ‡•á‡§∞‡•á ‡§ú‡•Ä‡§µ‡§® ‡§∏‡§Ç‡§ï‡•á‡§§ ‡§Æ‡•á‡§∞‡•á ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§ï‡•ç‡§Ø‡§æ ‡§¨‡§§‡§æ‡§§‡•á ‡§π‡•à‡§Ç?",
                "‡§ï‡•ç‡§Ø‡§æ ‡§Æ‡•Å‡§ù‡•á ‡§Ö‡§™‡§®‡•á ‡§∞‡§ï‡•ç‡§§‡§ö‡§æ‡§™ ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§ö‡§ø‡§Ç‡§§‡§æ ‡§ï‡§∞‡§®‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è?"
            ],
            'kn': [
                "‡≤®‡≤®‡≥ç‡≤® ‡≤™‡≥ç‡≤∞‡≤æ‡≤£ ‡≤∏‡≤Ç‡≤ï‡≥á‡≤§‡≤ó‡≤≥‡≥Å ‡≤®‡≤®‡≥ç‡≤® ‡≤Ü‡≤∞‡≥ã‡≤ó‡≥ç‡≤Ø‡≤¶ ‡≤¨‡≤ó‡≥ç‡≤ó‡≥Ü ‡≤è‡≤®‡≥Å ‡≤∏‡≥Ç‡≤ö‡≤ø‡≤∏‡≥Å‡≤§‡≥ç‡≤§‡≤µ‡≥Ü?",
                "‡≤®‡≤®‡≥ç‡≤® ‡≤∞‡≤ï‡≥ç‡≤§‡≤¶‡≥ä‡≤§‡≥ç‡≤§‡≤°‡≤¶ ‡≤¨‡≤ó‡≥ç‡≤ó‡≥Ü ‡≤®‡≤æ‡≤®‡≥Å ‡≤ö‡≤ø‡≤Ç‡≤§‡≤ø‡≤∏‡≤¨‡≥á‡≤ï‡≥á?"
            ]
        }
        
        queries = sample_queries.get(language, sample_queries['en'])
        
        for i, query in enumerate(queries[:2], 1):  # Limit to 2 queries for demo
            print(f"\nüí¨ Query {i}: {query}")
            print("üîÑ Generating AI response...")
            
            try:
                response = await self.ai_agent.generate_response(
                    user_input=query,
                    vitals_data=vitals_data,
                    language=language
                )
                
                print(f"ü§ñ AI Response: {response['response']}")
                
                if response.get('health_assessment'):
                    print(f"üìã Assessment: {response['health_assessment']}")
                
                if response.get('risk_level'):
                    risk_emoji = {
                        'low': 'üü¢',
                        'moderate': 'üü°',
                        'high': 'üî¥',
                        'emergency': 'üö®'
                    }
                    emoji = risk_emoji.get(response['risk_level'], '‚ùì')
                    print(f"{emoji} Risk Level: {response['risk_level'].title()}")
                
                if response.get('recommendations'):
                    print("üí° Recommendations:")
                    for rec in response['recommendations']:
                        print(f"  ‚Ä¢ {rec}")
                
                print("-" * 50)
                
            except Exception as e:
                print(f"‚ùå Error generating AI response: {str(e)}")
    
    async def demonstrate_first_aid(self, language='en'):
        """Demonstrate first aid guidance"""
        print(f"\nüöë === FIRST AID GUIDANCE DEMO ({language.upper()}) ===")
        
        conditions = ["Heart Attack", "Choking", "Severe Bleeding"]
        
        for condition in conditions[:1]:  # Demo with one condition
            print(f"\nüÜò Getting first aid guidance for: {condition}")
            try:
                guidance = self.ai_agent.get_first_aid_guidance(
                    condition=condition,
                    language=language
                )
                
                print(f"üìã Guidance: {guidance['response']}")
                
                if guidance.get('recommendations'):
                    print("‚ö° Immediate Actions:")
                    for rec in guidance['recommendations']:
                        print(f"  ‚Ä¢ {rec}")
                
            except Exception as e:
                print(f"‚ùå Error getting first aid guidance: {str(e)}")
    
    def demonstrate_multilingual_support(self):
        """Demonstrate multilingual capabilities"""
        print("\nüåç === MULTILINGUAL SUPPORT DEMO ===")
        
        languages = ['en', 'hi', 'kn']
        test_key = 'medical_disclaimer'
        
        for lang in languages:
            lang_name = self.multilingual.supported_languages[lang]
            translation = self.multilingual.get_translation(test_key, lang)
            print(f"\nüó£Ô∏è {lang_name} ({lang}):")
            print(f"   {translation}")
        
        # Demo medical terms glossary
        print("\nüìö Medical Terms Glossary:")
        glossary = self.multilingual.get_medical_terms_glossary('en')
        for term, translation in list(glossary.items())[:5]:
            print(f"  ‚Ä¢ {term}: {translation}")
    
    def demonstrate_data_export(self):
        """Demonstrate data export functionality"""
        print("\nüìÅ === DATA EXPORT DEMO ===")
        
        # Export as JSON
        json_data = self.vitals_system.export_vitals_data('json')
        print("‚úÖ Vitals data exported as JSON:")
        print(f"   üìÑ Data size: {len(json_data)} characters")
        
        # Export as CSV
        csv_data = self.vitals_system.export_vitals_data('csv')
        print("‚úÖ Vitals data exported as CSV:")
        print(f"   üìä Data size: {len(csv_data)} characters")
        
        # Show sample of JSON data
        try:
            data_preview = json.loads(json_data)
            print(f"\nüìã Sample JSON data (first entry):")
            first_key = list(data_preview.keys())[0]
            first_entry = data_preview[first_key]
            print(f"   {first_key}: {first_entry['value']} {first_entry['unit']} ({first_entry['status']})")
        except:
            print("   (Data preview unavailable)")
    
    async def run_full_demo(self):
        """Run the complete demo"""
        print("üöÄ Starting Intel AI Healthcare Kiosk Full Demo")
        print("=" * 60)
        
        # Load sample data
        sample_data = self.load_sample_data()
        normal_patient = sample_data['sample_vitals']['normal_patient']
        
        # 1. Vitals Collection Demo
        vitals_data = self.demonstrate_vitals_collection(normal_patient)
        
        # 2. Multilingual Support Demo
        self.demonstrate_multilingual_support()
        
        # 3. AI Assessment Demo (English)
        await self.demonstrate_ai_assessment(vitals_data, 'en')
        
        # 4. AI Assessment Demo (Hindi) - if time permits
        print("\nüîÑ Testing Hindi language support...")
        await self.demonstrate_ai_assessment(vitals_data, 'hi')
        
        # 5. First Aid Demo
        await self.demonstrate_first_aid('en')
        
        # 6. Data Export Demo
        self.demonstrate_data_export()
        
        # Summary
        print("\nüéâ === DEMO COMPLETE ===")
        print("‚úÖ All major features demonstrated successfully!")
        print("\nüìã Features Showcased:")
        print("  ‚Ä¢ 28 Vital Signs Collection & Analysis")
        print("  ‚Ä¢ AI-Powered Health Assessment")
        print("  ‚Ä¢ Multilingual Support (EN/HI/KN)")
        print("  ‚Ä¢ First Aid Guidance")
        print("  ‚Ä¢ Health Score Calculation")
        print("  ‚Ä¢ Data Export (JSON/CSV)")
        print("  ‚Ä¢ Medical Disclaimers & Safety")
        
        print(f"\nüåê To launch the full web interface:")
        print(f"   streamlit run app.py")
        print(f"\nüîß Or run the setup script:")
        print(f"   python setup.py")

def main():
    """Main demo function"""
    demo = HealthcareKioskDemo()
    
    # Check if this is a quick test or full demo
    if len(sys.argv) > 1 and sys.argv[1] == '--quick':
        print("üèÉ‚Äç‚ôÄÔ∏è Running quick vitals collection test...")
        sample_data = demo.load_sample_data()
        demo.demonstrate_vitals_collection(sample_data['sample_vitals']['normal_patient'])
    else:
        # Run full async demo
        asyncio.run(demo.run_full_demo())

if __name__ == "__main__":
    main()
